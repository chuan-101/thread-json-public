<!doctype html>
<html lang="zh-CN" data-theme="Fable">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Echo：My GPT</title>
  <meta name="color-scheme" content="light"/>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
  <style>
    /* ---- Syzygy's Warm Analog Retro Style ---- */
    :root {
      --radius: 4px; /* 微圆角，复古但不尖锐 */
      --gap: 20px;
      
      /* 基础字体设置 - 追求屏幕阅读感 */
      --font-ui: "Menlo", "Consolas", "Monaco", "Courier New", monospace; /* 等宽字体带来数据感 */
      --font-body: system-ui, -apple-system, sans-serif;
      
      /* 纹理透明度 */
      --noise-opacity: 0.03;
      --scanline-opacity: 0.02;

      /* ---- Fable (默认：参考你的图片 - 暖米色/深炭灰/柔红) ---- */
      --bg: #f2f0e6;            /* 暖米色纸张感背景 */
      --text: #2c2c2c;          /* 深炭灰文本 */
      --card-bg: #e6e4dc;       /* 比背景稍深的卡片底色 */
      --card-highlight: #2c2c2c;/* 反色卡片（深色块） */
      --text-highlight: #f2f0e6;/* 反色卡片上的文字 */
      --primary: #c97c7c;       /* 莫兰迪红 */
      --accent: #8FA3A3;        /* 灰调青 */
      --border: rgba(44, 44, 44, 0.3);
    }

    /* ---- Theme: Galaxy (柔和紫灰 - 梦境感) ---- */
    html[data-theme="Galaxy"] {
      --bg: #e8e6f0;
      --text: #2a2a35;
      --card-bg: #dedce8;
      --card-highlight: #4a4a5e;
      --text-highlight: #e8e6f0;
      --primary: #948cb5;
      --accent: #b5a4c9;
      --border: rgba(42, 42, 53, 0.3);
    }
    
    /* ---- Theme: Ferry (Gameboy - 复古液晶屏) ---- */
    html[data-theme="Ferry"] {
      --bg: #E3E8E3;
      --text: #2A3B2A;
      --card-bg: #D1D9D1;
      --card-highlight: #4A5D4A;
      --text-highlight: #E3E8E3;
      --primary: #6B8E6B;
      --accent: #2A3B2A;
      --border: rgba(42, 59, 42, 0.3);
    }

    /* ---- Theme: Ember (暖阳 - 陶土色) ---- */
    html[data-theme="Ember"] {
      --bg: #E6DFD8;
      --text: #4A3B32;
      --card-bg: #D6CFC7;
      --card-highlight: #5C403C;
      --text-highlight: #E6DFD8;
      --primary: #9E6B64;
      --accent: #8C6A5D;
      --border: rgba(92, 64, 60, 0.3);
    }

    /* ---- 全局重置与纹理 ---- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-ui); /* 全局使用等宽字体增强“数据记录”感 */
      color: var(--text);
      background-color: var(--bg);
      line-height: 1.5;
      padding-bottom: 60px;
      /* 噪点纹理 */
      position: relative;
    }
    
    /* 模拟屏幕纹理 */
    body::before {
      content: "";
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
      opacity: var(--noise-opacity);
      pointer-events: none;
      z-index: 9999;
    }

    .wrap { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
    .stack { display: flex; flex-direction: column; gap: var(--gap); }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    
    /* ---- 卡片设计 ---- */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
      transition: all 0.2s ease;
    }
    
    /* 这种深色块卡片模仿了你图片里的深色区域 */
    .card.dark-mode {
      background: var(--card-highlight);
      color: var(--text-highlight);
      border: none;
    }
    .card.dark-mode .muted { color: rgba(255,255,255,0.6); }
    .card.dark-mode input, .card.dark-mode select {
      background: rgba(255,255,255,0.1);
      color: var(--text-highlight);
      border-color: rgba(255,255,255,0.2);
    }

    /* ---- 排版 ---- */
    .h1 {
      font-family: "Cinzel", "Noto Serif SC", serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0px;
      margin: 0 0 4px;
      text-transform: uppercase;
    }
    .section-title {
      font-family: "Cinzel", "Noto Serif SC", serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-bottom: 16px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 8px;
    }
    .muted { opacity: 0.6; font-size: 13px; }
    .small { font-size: 12px; }

    /* ---- 控件 ---- */
    input[type="text"], textarea, select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.5);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 13px;
      border-radius: var(--radius);
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--primary); background: #fff; }

    .btn {
      appearance: none;
      border: 1px solid transparent;
      border-radius: var(--radius);
      padding: 8px 16px;
      background: var(--primary);
      color: #fff;
      font-family: var(--font-ui);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.5px;
    }
    .btn:hover { opacity: 0.9; }
    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn.secondary:hover { border-color: var(--text); }

    /* 开关 */
    .pill { display: inline-flex; gap: 8px; align-items: center; cursor: pointer; font-size: 13px; user-select: none;}
    input[type="checkbox"] {
      appearance: none;
      width: 14px; height: 14px;
      border: 1px solid var(--text);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    input[type="checkbox"]:checked { background: var(--text); }
    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
      background: var(--bg);
    }

    /* ---- 数据展示 ---- */
    .progress {
      height: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 99px;
      overflow: hidden;
      margin-top: 6px;
    }
    .bar {
      height: 100%; width: 0;
      background: var(--primary);
    }

    /* 表格 */
    .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 8px; font-weight: 600; opacity: 0.7; border-bottom: 1px solid var(--border); white-space: nowrap;}
    td { padding: 12px 8px; border-bottom: 1px solid var(--border); }
    td.num, th.num { text-align: right; font-variant-numeric: tabular-nums; }
    tr:last-child td { border-bottom: none; }
    tbody tr:nth-child(even) {
      background-color: rgba(0,0,0, 0.03);
    }

    /* 鼠标悬停高亮：这一行变色，让眼睛聚焦 */
    tbody tr:hover {
      background-color: var(--card-highlight); /* 用主题里的深色块 */
      color: var(--text-highlight); /* 文字反白 */
      cursor: default;
    }

    /* 悬停时，里面原本淡色的文字也要变亮 */
    tbody tr:hover .muted {
      color: rgba(255,255,255, 0.7);
      opacity: 1;
    }

    /* 词云 */
    .cloud {
      min-height: 200px;
      display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;
      padding: 20px;
    }
    .cloud span {
      /* 1. 基础布局：让它像个小砖块 */
      display: inline-block; 
      line-height: 1;
      
      /* 2. 标签外观：背景、边框、圆角 */
      background-color: rgba(255, 255, 255, 0.5); /* 半透明白色底，适应所有主题 */
      border: 1px solid var(--border);            /* 加上细边框 */
      border-radius: 4px;                         /* 微微的圆角 */
      
      /* 3. 呼吸感：用 em 单位，让内边距随字号自动变大变小 */
      padding: 0.4em 0.8em; 
      
      /* 4. 细节微调 */
      color: var(--text);
      cursor: default;     /* 鼠标放上去是箭头，不是光标 */
      transition: all 0.2s ease; /* 让变化丝滑一点 */
      
      /* 5. 阴影：增加一点点立体感，像贴纸 */
      box-shadow: 1px 1px 2px rgba(0,0,0,0.03);
    }

    /* ---- 交互：鼠标滑过时 ---- */
    /* 当你碰到它，它会变亮、变实，像被唤醒一样 */
    .cloud span:hover {
      background-color: var(--primary); /* 变成主题色 */
      color: #fff;                      /* 文字变白 */
      border-color: var(--primary);     
      opacity: 1 !important;            /* 强制不透明，看得更清 */
      transform: translateY(-2px);      /* 微微上浮 */
      box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
    }

    /* 底部 */
    .footer {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: calc(100% - 40px); max-width: 800px;
      z-index: 100;
    }
    .footer .card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    /* 切换按钮 */
    .text-toggle button {
      background: none; border: none; padding: 0; cursor: pointer;
      font-family: var(--font-ui); color: var(--text); opacity: 0.4;
      font-size: 12px;
    }
    .text-toggle button.active { opacity: 1; font-weight: 700; text-decoration: underline; text-decoration-color: var(--primary); text-underline-offset: 4px;}

    /* 响应式表格调整 */
    @media (max-width:480px){
      .yr-table.responsive thead { display: none; }
      .yr-table.responsive tr { display: block; border-bottom: 1px solid var(--border); padding: 12px 0; }
      .yr-table.responsive td { display: flex; justify-content: space-between; border: none; padding: 4px 0; }
      .yr-table.responsive td::before { content: attr(data-label); opacity: 0.6; }
    }
    
    /* 打印/导出模式 */
    .printing .footer { position: static; transform: none; width: 100%; margin-top: 20px; }
    .printing .card { box-shadow: none; border: 1px solid var(--border); }
    .visually-hidden { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); }
    .row.tight { gap: 8px; }

    ::-webkit-scrollbar {
      width: 8px; /* 稍微细一点 */
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg); /* 轨道颜色和背景融合 */
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border); /* 滑块颜色用边框色，低调 */
      border-radius: 4px;
      border: 2px solid var(--bg); /* 加个边框让滑块变细，像悬浮一样 */
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary); /* 鼠标放上去变亮，提示交互 */
    }

    .year-ticket {
      background: rgba(255,255,255, 0.4); /* 微微透的纸张感 */
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      position: relative;
      overflow: hidden;
    }
    
    /* 小票头部：年份 */
    .ticket-header {
      background: var(--card-highlight); /* 深色底 */
      color: var(--text-highlight);      /* 亮色字 */
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Cinzel', serif; /* 之前引用的复古字体 */
    }
    .ticket-year { font-size: 20px; font-weight: 700; letter-spacing: 2px; }
    .ticket-meta { font-size: 12px; opacity: 0.8; font-family: var(--font-ui); }

    /* 数据网格：像仪表盘一样排列 */
    .ticket-grid {
      display: grid;
      /* 桌面端：4列 */
      grid-template-columns: repeat(4, 1fr); 
      gap: 1px; /*利用gap制造分割线效果*/
      background: var(--border); /* 网格线的颜色 */
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    
    /* 每一个数据格 */
    .ticket-cell {
      background: var(--card-bg); /* 回到卡片底色 */
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* 手机端适配：变成2列，甚至1列 */
    @media (max-width: 600px) {
      .ticket-grid {
        grid-template-columns: 1fr 1fr; /* 手机上两列显示 */
      }
    }

    /* 数据样式 */
    .t-label { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
    .t-value { font-size: 16px; font-weight: 600; font-family: var(--font-ui); color: var(--text); }
    .t-sub   { font-size: 11px; opacity: 0.5; margin-top: 2px; }
    
    /* 连续活跃那一行单独占满，更有分量 */
    .ticket-footer {
      padding: 16px 20px;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }
    .streak-icon { 
      width:32px; height:32px; 
      background:var(--primary); color:#fff; 
      border-radius:50%; 
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap stack">
    <section class="card dark-mode stack" id="top">
      <header>
        <div class="row" style="justify-content: space-between; align-items:flex-start;">
            <div>
                <h1 class="h1">Echo：<span id="title-name">My GPT</span></h1>
                <p class="muted">年度数据可视化报告 // A Year By The Numbers</p>
            </div>
            <div style="text-align:right; opacity:0.5; font-size:10px;">
                <span style="display:inline-block; width:8px; height:8px; background:var(--primary); border-radius:50%; margin-right:4px;"></span>
                LIVE
            </div>
        </div>
      </header>

      <div class="stack" style="margin-top:10px;">
        <div class="row tight">
          <input type="file" id="file" accept=".json,application/json" class="visually-hidden" />
          <label for="file" class="btn secondary" style="color:var(--text-highlight); border-color:rgba(255,255,255,0.3)" id="btn-file">选择文件</label>
          <span id="file-name" class="small muted">等待数据导入...</span>
          <button class="btn" style="background:var(--text-highlight); color:var(--card-highlight);" id="btn-parse">开始解析</button>
          <button class="btn secondary" style="color:var(--text-highlight); border-color:rgba(255,255,255,0.3)" id="btn-cancel">重置</button>
        </div>

        <div class="row">
          <div style="flex:2;min-width:200px">
            <label class="small muted" style="display:block; margin-bottom:4px;">RENAME // 标题替换</label>
            <input id="title-input" type="text" placeholder="例如：G的名字+你的名字"/>
          </div>
          <div style="flex:1;min-width:140px">
            <label class="small muted" style="display:block; margin-bottom:4px;">THEME // 界面风格</label>
            <select id="theme">
              <option value="Fable">Fable (暖调)</option>
              <option value="Galaxy">Galaxy (紫灰)</option>
              <option value="Ferry">Ferry (复古绿)</option>
              <option value="Ember">Ember (陶土)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label class="pill"><input type="checkbox" id="mask"/> <span class="muted">数据脱敏模式</span></label>
        </div>

        <div class="stack" style="gap:10px; margin-top:8px;">
          <div>
            <div style="display:flex; justify-content:space-between;" class="small muted"><span>解析进度</span> <span id="p-parse-val"></span></div>
            <div class="progress" style="background:rgba(255,255,255,0.1)"><div class="bar" style="background:var(--primary)" id="p-parse"></div></div>
          </div>
          <div>
            <div style="display:flex; justify-content:space-between;" class="small muted"><span>统计计算</span> <span id="stats-phase-label"></span></div>
            <div class="progress" style="background:rgba(255,255,255,0.1)"><div class="bar" style="background:var(--primary)" id="p-stat"></div></div>
          </div>
           <div style="height:0; overflow:hidden"><div class="bar" id="p-shard"></div></div>
        </div>
      </div>
    </section>

    <main class="stack" id="results">
      <section class="card stack" id="card-yearly">
        <div class="section-title">01 / YEARLY LOGS (年度档案)</div>
        <div id="yearly-flow" class="stack">
          <span class="muted" style="text-align:center; padding:20px;">等待数据加载...</span>
        </div>
      </section>

      <section class="card stack" id="card-cloud">
        <div class="row" style="justify-content:space-between;">
            <div class="section-title" style="margin-bottom:0; border-bottom:none;">02 / TOP 10 KEYWORDS (记忆碎片)</div>
            <div class="text-toggle small" id="cloud-toggle" role="group">
            <button type="button" data-mode="phrases" class="active">词组</button>
            <span style="opacity:0.2">|</span>
            <button type="button" data-mode="words">单字</button>
            </div>
        </div>
        <div style="border-top:1px dashed var(--border); margin-top:8px; padding-top:10px;">
            <div class="cloud" id="cloud">
            <span class="muted small">暂无数据</span>
            </div>
        </div>
      </section>

      <section class="card stack" id="card-models">
        <div class="section-title">03 / MODEL USAGE (模型偏好)</div>
        <div class="row small" style="align-items:center; gap:8px; margin-bottom:12px;">
          <label class="muted" for="window">统计范围：</label>
          <select id="window" style="width:auto; padding:4px 8px;">
            <option value="all">全部时间</option>
          </select>
          <span class="muted small" style="margin-left:auto;">* 仅统计GPT回复</span>
        </div>
        <div id="models-chart" class="table-scroll">
          <span class="muted small" style="display:block; text-align:center; padding:20px;">等待计算...</span>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="card">
        <span class="small muted">Echo: My GPT Analysis</span>
        <button class="btn" id="btn-save">保存为长图</button>
      </div>
    </footer>
  </div>

  <script type="module">
    import { parseJSONStream } from './src/ingest/stream-parse.js';
    import { clearAll, listShards, readShardMessages } from './src/ingest/db.js';
    import { WorkerPool } from './src/workers/pool.js';
    import { mergePartials, exactRecount, scoreCandidates, buildTopViews, reconcileTopViews } from './src/stats/merge.js';
    import { cutoff90Days, cutoff365Days, filterMessagesByWindow, computeModelShare, resetModelAgg, getModelShare, bumpModelBucket } from './src/stats/models.js';
    import { finalizeYearAgg, computeYearlyMetrics } from './src/stats/timeline.js';
    
    // —— 主题下拉 —— //
    const themeSel = document.getElementById('theme');
    themeSel.addEventListener('change', ()=> {
      document.documentElement.setAttribute('data-theme', themeSel.value);
    });

    async function runStatsPipeline({ mask }) {
      if (cancelRequested) return;
      try {
        let shards = [];
        const cutoff = cutoff90Days();
        try {
          shards = await listShards({ cutoff });
        } catch (err) {
          console.error('读取分片列表失败', err);
          return;
        }
        if (cancelRequested) return;

        const allShards = Array.isArray(shards) ? shards.filter((s) => s && s.id != null) : [];
        if (!allShards.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 无可用分片' });
          await yieldToUi();
          refreshCloud();
          return;
        }

        const recentShards = allShards
          .filter((shard) => {
            if (typeof shard?.maxTs === 'number' && Number.isFinite(shard.maxTs)) {
              return shard.maxTs >= cutoff;
            }
            return true;
          })
          .sort((a, b) => {
            const aMax = typeof a?.maxTs === 'number' ? a.maxTs : typeof a?.minTs === 'number' ? a.minTs : -Infinity;
            const bMax = typeof b?.maxTs === 'number' ? b.maxTs : typeof b?.minTs === 'number' ? b.minTs : -Infinity;
            if (bMax !== aMax) return bMax - aMax;
            return (b.id || 0) - (a.id || 0);
          });

        if (!recentShards.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 无近90天分片' });
          await yieldToUi();
          refreshCloud();
          return;
        }

        updateProgressBars({ statsPct: 0, statsPhase: '阶段1 · MG/CMS（近90天）' });

        const workerUrl = new URL('./src/workers/shard-worker.js', import.meta.url).href;
        let poolSize = 4;
        if (typeof navigator !== 'undefined' && typeof navigator.hardwareConcurrency === 'number') {
          const suggested = Math.max(1, Math.floor(navigator.hardwareConcurrency - 1));
          poolSize = Math.min(4, Math.max(suggested, 1));
        }
        poolSize = Math.max(1, Math.min(poolSize, recentShards.length));
        if (poolSize < 3 && recentShards.length >= 3) {
          poolSize = 3;
        }

        const pool = new WorkerPool(poolSize, workerUrl);
        const partials = [];
        let completed = 0;

        try {
          for (const shard of recentShards) {
            if (cancelRequested) break;
            const messages = await readShardMessages(shard.id);
            if (cancelRequested) break;
            const filtered = filterMessagesByWindow(messages, cutoff);
            if (!filtered.length) {
              completed += 1;
              updateProgressBars({ statsPct: Math.min(50, (completed / recentShards.length) * 50) });
              await yieldToUi();
              continue;
            }
            const result = await pool.run({
              shardId: shard.id,
              messages: filtered,
              mask,
              cutoff,
            });
            if (cancelRequested) break;
            if (result?.error) {
              throw new Error(result.error.message || 'Worker 计算失败');
            }
            partials.push({ ...result, shardId: shard.id });
            completed += 1;
            updateProgressBars({ statsPct: Math.min(50, (completed / recentShards.length) * 50) });
            await yieldToUi();
          }
        } finally {
          await pool.terminate();
        }

        if (cancelRequested) return;

        const merged = mergePartials(partials);
        statsState.candidates = merged.candidates;
        statsState.candidatesByN = merged.candidatesByN || { 1: [], 2: [], 3: [] };
        statsState.totalTokens = merged.totalTokens;

        if (!statsState.candidates.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 窗口内无候选' });
        } else {
          updateProgressBars({ statsPct: 50, statsPhase: '阶段2 · 精确重算（近90天）' });
        }

        if (!statsState.candidates.length) {
          await yieldToUi();
          statsState.counts = new Map();
          statsState.sortedCandidates = [];
          statsState.top10 = [];
          statsState.candidatesByN = { 1: [], 2: [], 3: [] };
          statsState.views = { phrases: [], words: [] };
          refreshCloud();
          return;
        }

        const now = typeof performance !== 'undefined' && typeof performance.now === 'function'
          ? () => performance.now()
          : () => Date.now();
        const recountStart = now();
        const iterShardText = async (shardId) => {
          if (cancelRequested) {
            return { messages: [] };
          }
          const messages = await readShardMessages(shardId);
          if (cancelRequested) {
            return { messages: [] };
          }
          const filtered = filterMessagesByWindow(messages, cutoff);
          if (!filtered.length) {
            return { messages: [] };
          }
          return { messages: filtered };
        };
        iterShardText.shardIds = recentShards.map((s) => s.id);
        iterShardText.cutoff = cutoff;
        iterShardText.mask = mask;

        updateProgressBars({ statsPct: 50, statsPhase: '阶段2 · Recount phrases …' });

        const recountMap = await exactRecount(
          merged.candidates,
          iterShardText,
          async ({ doneShards, totalShards }) => {
            if (cancelRequested) return;
            const phasePct = totalShards ? 50 + (doneShards / totalShards) * 50 : 100;
            updateProgressBars({ statsPct: Math.min(100, phasePct), statsPhase: '阶段2 · Recount phrases …' });
            if (DEBUG_STATS) {
              const elapsedMs = Math.round(now() - recountStart);
              console.debug('[stats]', { phase: 'recount', doneShards, totalShards, elapsedMs });
            }
            await yieldToUi();
          },
          { shouldAbort: () => cancelRequested },
        );
        const recountEnd = now();
        if (cancelRequested) return;
        statsState.recountTimeMs = recountEnd - recountStart;
        statsState.counts = recountMap;
        const scored = scoreCandidates(recountMap, statsState.totalTokens);
        statsState.sortedCandidates = scored;
        updateProgressBars({ statsPct: 100, statsPhase: '完成 · 近90天处理完毕' });

        refreshCloud();

        if (DEBUG_STATS) {
          console.debug('[stats]', {
            totalTokens: statsState.totalTokens,
            distinctCandidates: statsState.counts.size,
            recountTimeMs: Math.round(statsState.recountTimeMs),
          });
        }
      } catch (err) {
        if (err && typeof err === 'object') {
          err.__stats = true;
        }
        statsState.counts = new Map();
        statsState.sortedCandidates = [];
        statsState.top10 = [];
        statsState.totalTokens = 0;
        statsState.recountTimeMs = 0;
        statsState.candidatesByN = { 1: [], 2: [], 3: [] };
        statsState.views = { phrases: [], words: [] };
        refreshCloud();
        throw err;
      }
    }

    // —— 标题替换（仅替换“GPT”段） —— //
    const titleInput = document.getElementById('title-input');
    const titleName  = document.getElementById('title-name');
    titleInput.addEventListener('input', () => {
      const v = (titleInput.value || 'My GPT').trim();
      titleName.textContent = v;
      document.title = `Echo：${v}`;
    });

    // —— 进度条占位：接入解析/统计后在此更新 —— //
    const p1=document.getElementById('p-parse'), p2=document.getElementById('p-shard'), p3=document.getElementById('p-stat');
    const statsPhaseLabel = document.getElementById('stats-phase-label');
    const setProgress=(el,val)=>{ el.style.width=Math.max(0,Math.min(100,val))+'%'; };
    const setStatsPhase = (text) => {
      if (!statsPhaseLabel) return;
      const next = text ? String(text) : '';
      statsPhaseLabel.textContent = next;
      statsPhaseLabel.style.display = next ? '' : 'none';
    };
    const yieldToUi = () => new Promise((resolve) => setTimeout(resolve, 0));
    const resetProgressBars = () => {
      setProgress(p1,0);
      setProgress(p2,0);
      setProgress(p3,0);
      setStatsPhase('');
    };

    const maskInput = document.getElementById('mask');

    const state = {
      mask: false,
    };

    const statsState = {
      counts: new Map(),
      sortedCandidates: [],
      candidates: [],
      candidatesByN: { 1: [], 2: [], 3: [] },
      totalTokens: 0,
      recountTimeMs: 0,
      top10: [],
      cloudMode: 'phrases',
      views: { phrases: [], words: [] },
    };

    const modelsState = {
      messages: [],
      window: 'last12months',
      now: Date.now(),
      share: { total: 0, rows: [], buckets: [] },
      loading: false,
      error: null,
    };

    const yearlyState = {
      data: {},
    };

    const DEBUG_STATS = false;

    // —— 文件选择与开始/中断 —— //
    const fileInput=document.getElementById('file');
    const fileNameSpan = document.getElementById('file-name');
    const parseBtn = document.getElementById('btn-parse');
    const cancelBtn = document.getElementById('btn-cancel');
    const parseBtnLabel = parseBtn.textContent;
    const cloudToggle = document.getElementById('cloud-toggle');
    const modelWindowSelect = document.getElementById('window');
    const modelsChartHost = document.getElementById('models-chart');

    let currentRunPromise = null;
    let currentController = null;
    let cancelRequested = false;

    const updateProgressBars = ({ parsePct, shardPct, statsPct, statsPhase }) => {
      if (typeof parsePct === 'number') setProgress(p1, parsePct);
      if (typeof shardPct === 'number') setProgress(p2, shardPct);
      if (typeof statsPct === 'number') setProgress(p3, statsPct);
      if (statsPhase !== undefined) setStatsPhase(statsPhase);
    };

    const resetUiState = () => {
      resetProgressBars();
      parseBtn.disabled = false;
      parseBtn.textContent = parseBtnLabel;
      cancelBtn.disabled = false;
    };

    function updateCloudToggleButtons(mode) {
      if (!cloudToggle) return;
      const nextMode = mode === 'words' ? 'words' : 'phrases';
      const buttons = cloudToggle.querySelectorAll('button[data-mode]');
      buttons.forEach((btn) => {
        const isActive = btn.dataset.mode === nextMode;
        btn.classList.toggle('active', isActive);
      });
    }

    if (cloudToggle) {
      cloudToggle.addEventListener('click', (event) => {
        const target = event.target.closest('button[data-mode]');
        if (!target) return;
        const mode = target.dataset.mode === 'words' ? 'words' : 'phrases';
        if (statsState.cloudMode === mode) {
          updateCloudToggleButtons(mode);
          return;
        }
        statsState.cloudMode = mode;
        updateCloudToggleButtons(mode);
        refreshCloud();
      });
    }

    updateCloudToggleButtons(statsState.cloudMode);

    resetModelShareState();

    // 动态填充年份选项
    function populateYearOptions() {
      if (!modelWindowSelect) return;
      const years = Object.keys(yearlyState.data || {})
        .map(y => Number(y))
        .filter(y => !isNaN(y))
        .sort((a, b) => b - a); // 降序排列
      
      const currentValue = modelWindowSelect.value;
      modelWindowSelect.innerHTML = '<option value="all">全部时间</option>';
      
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = String(year);
        option.textContent = `${year}年`;
        modelWindowSelect.appendChild(option);
      });
      
      modelWindowSelect.value = 'all';
    }

    if (modelWindowSelect) {
      modelsState.window = modelWindowSelect.value || 'all';
      
      modelWindowSelect.addEventListener('change', () => {
        const next = modelWindowSelect.value;
        if (modelsState.window === next) return;
        modelsState.window = next;
        if (modelsState.messages.length && !modelsState.loading) {
          recomputeModelShareView();
        } else {
          renderModelShare();
        }
      });
    }

    renderModelShare();
    resetProgressBars();

    fileInput.addEventListener('change', () => {
      const fileName = fileInput.files?.[0]?.name || '';
      fileNameSpan.textContent = fileName ? `已选: ${fileName}` : '';
    });
    parseBtn.addEventListener('click', async ()=>{
      if(currentRunPromise){ return; }
      if(!fileInput.files?.[0]){ alert('请先选择文件'); return; }

      cancelRequested = false;
      
      // 每次导入前先清空旧数据
      try {
        await clearAll();
      } catch (err) {
        console.error('清空旧数据失败', err);
      }
      
      resetProgressBars();
      state.mask = !!maskInput?.checked;
      statsState.counts.clear();
      statsState.sortedCandidates = [];
      statsState.candidates = [];
      statsState.candidatesByN = { 1: [], 2: [], 3: [] };
      statsState.totalTokens = 0;
      statsState.recountTimeMs = 0;
      statsState.top10 = [];
      statsState.views = { phrases: [], words: [] };
      refreshCloud();
      resetModelShareState();
      renderModelShare();
      yearlyState.data = {};
      renderYearlyOverview({});
      parseBtn.disabled = true;
      parseBtn.textContent = '处理中…';
      cancelBtn.disabled = false;
      

      const file = fileInput.files[0];
      const assistName = (document.getElementById('assist-filter')?.value || '').trim();
      currentController = new AbortController();

      const run = (async () => {
        try {
          const parseResult = await parseJSONStream(
            file,
            () => {
              /* 消息级聚合将在后续任务接入 */
            },
            (progress) => {
              if (cancelRequested) return;
              updateProgressBars(progress || {});
            },
            { assistName, signal: currentController.signal },
          );
          if (!cancelRequested) {
            const yearly = finalizeYearAgg();
            yearlyState.data = yearly;
            renderYearlyOverview(yearly);
            populateYearOptions();
            modelsState.window = modelWindowSelect?.value || 'all';
          }
          if (!cancelRequested && parseResult?.aborted !== true) {
            await runStatsPipeline({ mask: state.mask });
          }
          if (!cancelRequested) {
            await computeModelUsageShare();
          }
        } catch (err) {
          if (err?.name !== 'AbortError') {
            const label = err?.__stats ? '统计失败' : '解析失败';
            console.error(label, err);
          }
        } finally {
          currentController = null;
          currentRunPromise = null;
          parseBtn.disabled = false;
          parseBtn.textContent = parseBtnLabel;
          if (cancelRequested) {
            resetProgressBars();
          }
        }
      })();

      currentRunPromise = run;
      try {
        await run;
      } catch (err) {
        if (err?.name !== 'AbortError') {
          console.error('CRITICAL_ERROR', err);
        }
      }
    });
    cancelBtn.addEventListener('click', async ()=>{
      cancelRequested = true;
      if(currentController && !currentController.signal.aborted){
        currentController.abort();
      }

      try {
        await currentRunPromise;
      } catch (err) {
        if (err?.name !== 'AbortError') {
          console.error('CANCEL_ERROR', err);
        }
      } finally {
        currentRunPromise = null;
        currentController = null;
      }

      try {
        await clearAll();
      } catch (err) {
        console.error('DB_CLEAR_FAIL', err);
      }

      statsState.counts.clear();
      statsState.sortedCandidates = [];
      statsState.candidates = [];
      statsState.candidatesByN = { 1: [], 2: [], 3: [] };
      statsState.totalTokens = 0;
      statsState.recountTimeMs = 0;
      statsState.top10 = [];
      statsState.views = { phrases: [], words: [] };
      refreshCloud();
      resetModelShareState();
      renderModelShare();
      yearlyState.data = {};
      renderYearlyOverview({});

      resetUiState();
      cancelRequested = false;
    });

    // —— 年度概览渲染 —— //
    function updateYearlyTableResponsive(){
      const table = document.getElementById('yearly-table');
      if (!table || typeof window === 'undefined') return;
      const responsive = typeof window.matchMedia === 'function'
        ? window.matchMedia('(max-width: 480px)').matches
        : window.innerWidth <= 480;
      table.classList.toggle('responsive', !!responsive);
    }

    if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
      window.addEventListener('resize', updateYearlyTableResponsive);
    }

    function renderYearlyOverview(summary){
      const container = document.getElementById('yearly-flow');
      if (!container) return;
      container.innerHTML = '';

      const entries = Object.entries(summary || {})
        .map(([year, value]) => [Number(year), value])
        .filter(([year]) => !Number.isNaN(year))
        .sort((a, b) => b[0] - a[0]);

      if (!entries.length) {
        container.innerHTML = '<div class="muted" style="text-align:center; padding:40px;">等待数据导入...</div>';
        return;
      }

      // 1. 格式化工具 (直接内置，防丢失)
      const fmt = new Intl.NumberFormat('en-US');
      const num = (v) => Number.isFinite(v) ? fmt.format(v) : '0';
      const avg = (v) => Number.isFinite(v) ? v.toFixed(1) : '0.0';

      // 2. 必须的辅助函数 (从你原来的代码里搬运过来的，确保逻辑不断)
      const resolveActiveDays = (days) => {
        if (!days) return 0;
        if (days instanceof Set) return days.size;
        if (Array.isArray(days)) return days.length;
        return Number(days) || 0;
      };

      const toOrdinal = (val) => {
        if (typeof val === 'string') {
          const parts = val.split('-');
          if (parts.length === 3) return Date.UTC(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        }
        const n = Number(val);
        return (Number.isFinite(n) && !Number.isNaN(new Date(n).getTime())) 
          ? Date.UTC(new Date(n).getUTCFullYear(), new Date(n).getUTCMonth(), new Date(n).getUTCDate()) 
          : null;
      };

      const computeStreakStats = (days) => {
        const source = days instanceof Set ? Array.from(days) : Array.isArray(days) ? days : [];
        if (!source.length) return { streakCount: 0, longestStreak: 0 };
        const ordinals = source.map(toOrdinal).filter(Number.isFinite).sort((a, b) => a - b);
        if (!ordinals.length) return { streakCount: 0, longestStreak: 0 };
        
        const DAY_MS = 86400000;
        let streak = 0, longest = 0, current = 0, prev = null;
        ordinals.forEach((ts) => {
          if (prev === null || ts - prev > DAY_MS) {
            streak++; current = 1;
          } else if (ts - prev === DAY_MS) {
            current++;
          }
          if (current > longest) longest = current;
          prev = ts;
        });
        return { streakCount: streak, longestStreak: longest || 1, currentStreak: current };
      };

      // 3. 开始渲染小票
      // 注意：这里需要依赖外部的 computeYearlyMetrics，这是原本就在外部导入的，所以没问题
      const derived = computeYearlyMetrics(summary);
      const monthLabels = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];

      entries.forEach(([year, value]) => {
        const entry = value || {};
        const metrics = (derived && derived[year]) || {};
        
        // 提取数据
        const totalMsg = metrics.totalMessages ?? entry.totalMessages ?? 0;
        const gptMsg = metrics.assistantMsgs ?? entry.assistantMsgs ?? 0;
        const totalChar = metrics.totalChars ?? entry.totalChars ?? 0;
        const gptChar = metrics.assistantChars ?? entry.assistantChars ?? 0;
        const images = metrics.images ?? entry.images ?? 0;
        const avgDaily = metrics.avgCharsPerActiveDay ?? 0;
        const gptAvgLen = metrics.avgAssistantMsgLen ?? 0;
        
        const activeDaysSource = metrics.activeDays || entry.activeDays;
        const activeCount = resolveActiveDays(activeDaysSource);
        const streakStats = computeStreakStats(activeDaysSource);
        
        // 处理最活跃月
        const mostActiveMonth = metrics.mostActiveMonth ?? 0;
        let topMonthHtml = '<span class="muted">—</span>';
        if(mostActiveMonth > 0){
             const mName = monthLabels[mostActiveMonth - 1];
             const mCount = (metrics.charsByMonth || [])[mostActiveMonth - 1] || 0;
             topMonthHtml = `${mName} <span style="opacity:0.5; font-size:12px;">(${num(mCount)})</span>`;
        }

        // 构建 HTML 结构
        const ticket = document.createElement('div');
        ticket.className = 'year-ticket';
        ticket.innerHTML = `
          <div class="ticket-header">
            <div class="ticket-year">${year}</div>
            <div class="ticket-meta">ACTIVE: ${activeCount} DAYS</div>
          </div>
          
          <div class="ticket-grid">
            <div class="ticket-cell">
              <span class="t-label">消息总条数</span>
              <span class="t-value">${num(totalMsg)}</span>
              <span class="t-sub">GPT: ${num(gptMsg)}</span>
            </div>
            
            <div class="ticket-cell">
              <span class="t-label">总字数</span>
              <span class="t-value">${num(totalChar)}</span>
              <span class="t-sub">GPT: ${num(gptChar)}</span>
            </div>
            
            <div class="ticket-cell">
              <span class="t-label">日均字数</span>
              <span class="t-value">${avg(avgDaily)}</span>
              <span class="t-sub">字数 / 天</span>
            </div>
            
            <div class="ticket-cell">
              <span class="t-label">GPT平均字数</span>
              <span class="t-value">${avg(gptAvgLen)}</span>
              <span class="t-sub">字数 / 条</span>
            </div>

            <div class="ticket-cell">
              <span class="t-label">图片数</span>
              <span class="t-value">${num(images)}</span>
            </div>
             
             <div class="ticket-cell" style="grid-column: span 3;">
              <span class="t-label">PEAK MONTH (最活跃)</span>
              <span class="t-value">${topMonthHtml}</span>
            </div>
          </div>

          <div class="ticket-footer">
            <div class="streak-icon">❤</div>
            <div style="flex:1">
               <div style="font-weight:600; font-family:var(--font-ui);">LONGEST STREAK (最长连续活跃)</div>
               <div class="muted small">你曾在这一年连续 ${num(streakStats.longestStreak)} 天与GPT对话</div>
            </div>
            <div class="t-value" style="font-size:24px;">${num(streakStats.longestStreak)}</div>
          </div>
        `;

        container.appendChild(ticket);
      });
    }

    // —— 模型占比（近12个月） —— //
    function resetModelShareState() {
      modelsState.messages = [];
      modelsState.share = { total: 0, rows: [], buckets: [] };
      modelsState.loading = false;
      modelsState.error = null;
      modelsState.now = Date.now();
    }

    const modelNumberFormatter =
      typeof Intl !== 'undefined' && Intl.NumberFormat ? new Intl.NumberFormat() : null;

    function formatModelNumber(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '0';
      const rounded = Math.round(num);
      return modelNumberFormatter ? modelNumberFormatter.format(rounded) : String(rounded);
    }

    function resolveWindowLabel(windowOpt) {
        if (windowOpt === 'all') return '全部时间';
        const year = Number(windowOpt);
        if (!isNaN(year)) return `${year}年`;
        return windowOpt;
    }
    
    function renderModelShare() {
      if (!modelsChartHost) return;
      modelsChartHost.innerHTML = '';

      if (modelsState.loading) {
        const loading = document.createElement('span');
        loading.className = 'muted';
        loading.style.display = 'block';
        loading.style.padding = '20px';
        loading.style.textAlign = 'center';
        loading.textContent = '计算模型数据中...';
        modelsChartHost.appendChild(loading);
        return;
      }

      if (modelsState.error) {
        const error = document.createElement('span');
        error.className = 'muted';
        error.textContent = modelsState.error;
        modelsChartHost.appendChild(error);
        return;
      }

      const rows = Array.isArray(modelsState?.share?.rows) ? modelsState.share.rows : [];
      const total = Number(modelsState?.share?.total) || 0;

      if (!rows.length || total <= 0) {
        const placeholder = document.createElement('span');
        placeholder.className = 'muted';
        placeholder.style.display = 'block';
        placeholder.style.padding = '20px';
        placeholder.style.textAlign = 'center';
        placeholder.textContent = '暂无模型统计数据';
        modelsChartHost.appendChild(placeholder);
        return;
      }

      const table = document.createElement('table');
      table.className = 'data-table';

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['模型名称', '消息数', '占比'].forEach((label, idx) => {
        const th = document.createElement('th');
        th.textContent = label;
        if (idx > 0) th.className = 'num';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let needsDivider = true;
      let dataRowIndex = 0; 
      
      rows.forEach((entry) => {
        if (needsDivider && (entry.label === 'Tools' || entry.label === 'Unknown')) {
          const dividerRow = document.createElement('tr');
          dividerRow.style.background = 'transparent'; 
          const dividerCell = document.createElement('td');
          dividerCell.colSpan = 3;
          dividerCell.style.cssText = 'padding:0; height:1px; background:var(--border);';
          dividerRow.appendChild(dividerCell);
          tbody.appendChild(dividerRow);
          needsDivider = false;
        }
        
        const tr = document.createElement('tr');
        // if (dataRowIndex % 2 !== 0) {
        //   tr.style.background = 'rgba(0,0,0,.02)'; 
        // }
        dataRowIndex++;

        const modelCell = document.createElement('td');
        modelCell.textContent = entry.label || entry.id || '未知模型';
        modelCell.style.fontFamily = 'var(--font-ui)';
        tr.appendChild(modelCell);

        const msgCell = document.createElement('td');
        msgCell.className = 'num';
        msgCell.textContent = formatModelNumber(entry.messages);
        tr.appendChild(msgCell);

        const shareCell = document.createElement('td');
        shareCell.className = 'num';
        const pctLabel = Math.round((Number(entry.share) || 0) * 1000) / 10;
        shareCell.textContent = `${pctLabel.toFixed(1)}%`;
        tr.appendChild(shareCell);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      modelsChartHost.appendChild(table);

      const meta = document.createElement('div');
      meta.className = 'models-meta small muted';
      meta.style.marginTop = '12px';
      meta.style.textAlign = 'right';
      meta.textContent = `窗口：${resolveWindowLabel(modelsState.window)} · 总计 ${formatModelNumber(total)} 条`;
      modelsChartHost.appendChild(meta);
    }

    function recomputeModelShareView() {
      const messages = Array.isArray(modelsState.messages) ? modelsState.messages : [];
      const windowValue = modelsState.window;
      
      let filtered = messages;
      
      if (windowValue !== 'all') {
        const year = Number(windowValue);
        if (!isNaN(year)) {
          const yearStart = Date.UTC(year, 0, 1, 0, 0, 0, 0);
          const yearEnd = Date.UTC(year, 11, 31, 23, 59, 59, 999);
          filtered = messages.filter(msg => {
            const ts = typeof msg?.ts === 'number' ? msg.ts : null;
            return ts != null && ts >= yearStart && ts <= yearEnd;
          });
        }
      }
      
      resetModelAgg();
      filtered.filter(msg => msg?.role === 'assistant').forEach(msg => {
        bumpModelBucket(msg?.ts, msg?.role, msg);
      });
      
      modelsState.share = getModelShare({ window: windowValue, now: Date.now(), cutoff: 0 });
      renderModelShare();
    }

    async function computeModelUsageShare() {
      if (!modelsChartHost) return;
      modelsState.loading = true;
      modelsState.error = null;
      renderModelShare();

      const windowOpt = modelsState.window === 'all' ? 'all' : 'last12months';
      const now = Date.now();
      const windowCutoff = windowOpt === 'last12months' ? cutoff365Days(now) : 0;
      let shards = [];
      try {
        shards = await listShards();
      } catch (err) {
        modelsState.loading = false;
        modelsState.error = '数据库读取失败';
        console.error('Failed to list shards for model share', err);
        renderModelShare();
        return;
      }

      const collected = [];
      for (const shard of shards) {
        if (cancelRequested) break;
        try {
          const messages = await readShardMessages(shard.id);
          const filtered = filterMessagesByWindow(messages, 0);
          filtered.forEach((msg) => {
            collected.push({ ...msg, role: typeof msg?.role === 'string' ? msg.role : 'assistant' });
          });
        } catch (err) {
          console.error('Failed to read shard for model share', err);
        }
        if (collected.length % 2000 === 0) {
          await yieldToUi();
        }
      }

      if (cancelRequested) {
        modelsState.loading = false;
        return;
      }

      modelsState.now = now;
      modelsState.messages = collected;
      modelsState.share = computeModelShare(collected, {
        now,
        cutoff: windowCutoff,
        window: windowOpt,
      });
      modelsState.loading = false;
      renderModelShare();
    }

    // —— 词云渲染占位（接入统计后调用） —— //
    function renderCloud(words){
      const host=document.getElementById('cloud'); host.innerHTML='';
      if(!Array.isArray(words) || !words.length){
        const placeholder=document.createElement('span');
        placeholder.className='muted small';
        placeholder.textContent='暂无数据';
        host.appendChild(placeholder);
        return;
      }
      const maxScore = words.reduce((acc, item) => {
        const value = Number(item?.score);
        if (!Number.isFinite(value)) return acc;
        return Math.max(acc, Math.max(0, value));
      }, 0);
      const base = maxScore > 0 ? maxScore : 1;
      words.forEach((w)=>{
        const score = Number(w?.score);
        const weight = Number.isFinite(score) && score > 0 ? score / base : 0;
        const el=document.createElement('span');
        el.textContent=w.text;
        el.style.fontSize=(12+Math.round(24*weight))+'px';
        el.style.setProperty('--w', weight);
        el.setAttribute('data-w', String(weight));
        // 复古风：透明度变化
        el.style.opacity = 0.4 + (weight * 0.6);
        el.style.fontWeight = weight > 0.6 ? '700' : '400';
        host.appendChild(el);
      });
    }

    function updateTopViews(limit = 10) {
      const sorted = Array.isArray(statsState.sortedCandidates) ? statsState.sortedCandidates : [];
      const nextViews = buildTopViews(sorted, limit);
      statsState.views = reconcileTopViews(statsState.views, nextViews, { maxSwaps: 1 });
      return statsState.views;
    }

    function refreshCloud(){
      const limit = 10;
      const views = updateTopViews(limit) || {};
      const phraseViewRaw = Array.isArray(views.phrases) ? views.phrases : [];
      const wordViewRaw = Array.isArray(views.words) ? views.words : [];
      const phraseView = phraseViewRaw.slice(0, limit);
      const wordView = wordViewRaw.slice(0, limit);

      if (!phraseView.length && !wordView.length) {
        statsState.top10 = [];
        renderCloud([]);
        return;
      }

      const hasWordView = wordView.length > 0;
      const defaultView = phraseView.length ? phraseView : wordView;
      const active = (statsState.cloudMode === 'words' && hasWordView)
        ? wordView
        : defaultView;

      if (!active.length) {
        statsState.top10 = [];
        renderCloud([]);
        return;
      }

      const topScore = active[0]?.score || 0;
      const items = active.map((entry) => {
        const score = Number(entry?.score) || 0;
        const weight = topScore ? Math.max(0, score) / topScore : 0;
        return {
          text: entry.token,
          score,
          weight,
          count: Number(entry?.freq) || 0,
          pct: statsState.totalTokens ? (Number(entry?.freq) || 0) / statsState.totalTokens : 0,
          n: entry.n,
        };
      });

      statsState.top10 = items;
      renderCloud(items);
    }

    // —— 保存为图片（防截断版） —— //
    document.getElementById('btn-save').addEventListener('click', async ()=>{
      if(!window.html2canvas){ alert('无法使用内置导出，请手动截图'); return; }

      const root=document.documentElement, body=document.body;

      // 创建临时导出容器
      const exportContainer = document.createElement('div');
      exportContainer.style.cssText = 'padding:40px; background:'+getComputedStyle(document.body).backgroundColor;

      // 克隆标题
      const titleClone = document.createElement('div');
      titleClone.innerHTML = `
        <h1 style="font-size:24px;font-weight:700;margin:0 0 8px;color:var(--text);font-family:var(--font-ui)">
          Echo：<span>${document.getElementById('title-name').textContent}</span>
        </h1>
        <p style="opacity:.6;font-size:12px;margin:0 0 32px;color:var(--text);font-family:var(--font-ui); letter-spacing:1px;">
          EXPORT DATE: ${new Date().toLocaleDateString()}
        </p>
      `;

      // 克隆结果区
      const resultsClone = document.getElementById('results').cloneNode(true);

      exportContainer.appendChild(titleClone);
      exportContainer.appendChild(resultsClone);
      document.body.appendChild(exportContainer);

      const target = exportContainer;
      const BG = getComputedStyle(body).backgroundColor;
      const SCALE = 2;       
      const MARGIN = 40;     

      root.classList.add('printing');
      try{ if(document.fonts && document.fonts.ready){ await document.fonts.ready; } await new Promise(r=>setTimeout(r,50)); }catch(_){}

      const w=Math.ceil(Math.max(target.scrollWidth, target.clientWidth));
      const h=Math.ceil(Math.max(target.scrollHeight, target.clientHeight));

      const canvas = await html2canvas(target,{
        scale:SCALE, useCORS:true, backgroundColor:BG,
        x:0, y:0, width:w, height:h,
        windowWidth:Math.max(w, window.innerWidth),
        windowHeight:h, scrollX:0, scrollY:-window.scrollY,
        onclone:(doc)=>doc.documentElement.classList.add('printing')
      });

      // —— 关键：在原图外再包一层留白画布 —— //
      const pad = Math.round(MARGIN * SCALE);
      const framed = document.createElement('canvas');
      framed.width  = canvas.width  + pad*2;
      framed.height = canvas.height + pad*2;

      const ctx = framed.getContext('2d');
      ctx.fillStyle = BG;             
      ctx.fillRect(0,0,framed.width,framed.height);
      ctx.drawImage(canvas, pad, pad); 

      try {
        const safeName = document.getElementById('title-name').textContent.replace(/[\/\\:*?"<>|]/g, '-');
        const a = document.createElement('a');
        a.href = framed.toDataURL('image/png');
        a.download = `Echo_${safeName}_Report.png`;
        a.click();
      } catch(e) {
        alert('图片太大，导出失败。建议手动截图。');
      }

      root.classList.remove('printing');
      document.body.removeChild(exportContainer);
    });

    // —— 脱敏状态（统计时读取） —— //
    maskInput.addEventListener('change', (e)=> {
      state.mask = !!e.target.checked;
    });
    state.mask = !!maskInput?.checked;
    refreshCloud();
  </script>
</body>
</html>
