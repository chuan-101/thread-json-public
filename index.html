<!doctype html>
<html lang="zh-CN" data-theme="Fable">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Echo：My GPT</title>
  <meta name="color-scheme" content="light"/>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <style>
    /* ---- 主题与颜色变量（集中管理） ----
       每套主题需给出：主色、强调色、背景、文本、卡片底、词云默认色 */
    :root{
      --radius:16px; --pad:16px; --gap:16px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --border-soft:1px solid rgba(0,0,0,.10);

      /* Fable */
      --primary:#e3a9c4;      /* 主色：按钮/标题线/默认词云色 */
      --accent:#97b9d0;        /* 强调色：进度条渐变右侧、可选词云色 */
      --bg:#9db7dd;             /* 页面背景 */
      --text:#0A0F14;           /* 正文文本 */
      --card-bg:#f4f4f4;        /* 卡片底色（无边框）*/
    }
    html[data-theme="Galaxy"]{
      --primary:#796aa7; --accent:#e9a4ae; --bg:#f2f1f8; --text:#0A0F14; --card-bg:#e2d8e9; 
    }
    html[data-theme="Ferry"]{
      --primary:#699eb3; --accent:#a1ccdd; --bg:#f4d0e2; --text:#0A0F14; --card-bg:#f8edf3; 
    }
    html[data-theme="Ember"]{
      --primary:#df8164; --accent:#e5c481; --bg:#abc799; --text:#0A0F14; --card-bg:#fbf9ec; 
    }

    /* ---- 基础样式 ---- */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);}
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    .stack{display:flex;flex-direction:column;gap:var(--gap);}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;}
    .h1{font-size:28px;font-weight:700;margin:0 0 8px;}
    .muted{opacity:.65;font-size:14px;}
    .section-title{font-weight:700;margin:0 0 8px;border-left:4px solid var(--primary);padding-left:8px;}
    .card{background:var(--card-bg);border:none;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad);}
    #results>.card{margin-bottom:16px;}
    input[type="text"], textarea, select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--text);
    }
    .btn{appearance:none;border:0;border-radius:10px;padding:6px 10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,.12)}
    .pill{display:inline-flex;gap:6px;align-items:center;}
    .small{font-size:12px;opacity:.75}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .box{background:var(--card-bg);border:none;border-radius:12px;padding:12px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .kpi .n{font-size:18px;font-weight:800}

    .cloud{min-height:220px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:12px}
    .cloud span{display:inline-block;padding:2px 4px;border-radius:6px;color:var(--primary);font-weight:800}
    .cloud span[data-w]{opacity: calc(.65 + (.35 * var(--w,1)));}

    .text-toggle{display:flex;gap:8px;align-items:center;}
    .text-toggle button{border:0;background:none;padding:0;font:inherit;color:var(--text);opacity:.65;cursor:pointer;}
    .text-toggle button:hover,.text-toggle button:focus-visible{opacity:1;text-decoration:underline;}
    .text-toggle button.active{font-weight:600;opacity:1;}
    .text-toggle span{opacity:.4;}

    .table-scroll{overflow:auto;}
    table.data-table{width:100%;border-collapse:collapse;min-width:320px;}
    table.data-table thead th{padding:8px 12px;text-align:left;font-weight:600;font-size:13px;border-bottom:1px solid rgba(0,0,0,.12);}
    table.data-table tbody td{padding:10px 12px;font-size:14px;vertical-align:top;}
    table.data-table tbody tr:nth-child(even){background:rgba(0,0,0,.04);}
    table.data-table td.num, table.data-table th.num{text-align:right;}
    table.data-table td.streak{white-space:nowrap;}
    table.data-table td .small{font-size:12px;}

    .yr-table{width:100%;border-collapse:separate;border-spacing:0 6px;}
    .yr-table th,.yr-table td{padding:8px 10px;white-space:nowrap;}
    .yr-table .full{display:inline;}
    .yr-table .abbr{display:none;}

@media (max-width:480px){
  .yr-table.responsive{display:flex;flex-direction:column;gap:12px;}
  .yr-table.responsive thead{display:none;}
  .yr-table.responsive tr{
    display:block;
    background:var(--card-bg);
    border-radius:12px;
    padding:12px;
    box-shadow:var(--shadow);
  }
  .yr-table.responsive td{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px solid rgba(0,0,0,.05);
    font-size:13px;
  }
  .yr-table.responsive td:last-child{border-bottom:none;}
  .yr-table.responsive td::before{
    content:attr(data-label);
    opacity:.65;
    font-weight:600;
  }
  .yr-table.responsive td.num{text-align:right;font-weight:500;}
}

    /* 无障碍隐藏原生 file 输入，仅保留 label 按钮触发 */
.visually-hidden{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}
/* 紧凑行间距 */
.row.tight{ gap:8px; }

    /* 进度条 */
    .progress{height:10px;background:rgba(0,0,0,.06);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .3s}

    /* 页脚（粘滞） */
    .footer{position:sticky;bottom:0;background:linear-gradient(to top, rgba(246,251,253,.95), rgba(246,251,253,0));padding-top:8px}

    /* —— 截图护栏 —— */
    #results{overflow:visible;}
    .printing #results{overflow:visible;}
    .printing .footer{position:static;box-shadow:none;}
    .printing .card{box-shadow:none;border:none;background:var(--card-bg);}
  </style>
</head>
<body>
  <div class="wrap stack">
    <!-- 顶部：输入与外观 -->
    <section class="card stack" id="top">
      <header>
        <h1 class="h1">Echo：<span id="title-name">My GPT</span></h1>
        <p class="muted">Analyze last 3 months of assistant messages (word cloud/starters/catchphrases & model share). Yearly overview aggregates both assistant and user.</p>
      </header>

      <div class="stack">
<div class="row tight">
  <input type="file" id="file" accept=".json,application/json" class="visually-hidden" />
  <label for="file" class="btn secondary" id="btn-file">选择文件</label>
  <span id="file-name" class="small muted"></span>
  <button class="btn " id="btn-parse">开始解析</button>
  <button class="btn secondary " id="btn-cancel">中断/重置</button>
</div>

        <div class="row">
          <div style="flex:2;min-width:260px">
            <label class="small">标题中“GPT”的替换词</label>
            <input id="title-input" type="text" placeholder="例如：你的GPT的名字&你自己的名字"/>
          </div>
          <div style="flex:1;min-width:180px">
            <label class="small">主题选择</label>
            <select id="theme">
              <option value="Fable">Fable</option>
              <option value="Galaxy">Galaxy</option>
              <option value="Ferry">Ferry</option>
              <option value="Ember">Ember</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label class="pill"><input type="checkbox" id="mask"/> <span>脱敏开关</span></label>
        </div>

        <div class="stack">
          <div>
            <span class="small">解析进度</span>
            <div class="progress"><div class="bar" id="p-parse"></div></div>
          </div>
          <div>
            <span class="small">分片入库</span>
            <div class="progress"><div class="bar" id="p-shard"></div></div>
          </div>
          <div>
            <span class="small">统计计算</span>
            <div class="small muted" id="stats-phase-label"></div>
            <div class="progress"><div class="bar" id="p-stat"></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 中部：结果区 -->
    <main class="stack" id="results">
      <!-- 年度概览 -->
      <section class="card stack" id="card-yearly">
        <div class="section-title">年度概览</div>
        <div class="table-scroll">
          <table class="yr-table" id="yearly-table">
            <thead>
              <tr>
                <th><span class="full">年份</span><span class="abbr">年份</span></th>
                <th><span class="full">消息总条数</span><span class="abbr">消息总条数</span></th>
                <th><span class="full">总字数</span><span class="abbr">总字数</span></th>
                <th><span class="full">总图片数</span><span class="abbr">总图片数</span></th>
                <th><span class="full">日均字数</span><span class="abbr">日均字数</span></th>
                <th><span class="full">最活跃月</span><span class="abbr">最活跃月</span></th>
                <th><span class="full">GPT平均字数</span><span class="abbr">GPT平均字数</span></th>
                <th><span class="full">连续活跃</span><span class="abbr">连续活跃</span></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="muted">暂无统计</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 词云 -->
      <section class="card stack" id="card-cloud">
        <div class="section-title">Top10 词云</div>
        <div class="text-toggle small" id="cloud-toggle" role="group" aria-label="词云视图切换">
          <button type="button" data-mode="phrases" class="active" aria-pressed="true">Phrases (default)</button>
          <span>/</span>
          <button type="button" data-mode="words" aria-pressed="false">Words only (debug)</button>
        </div>
        <div class="cloud" id="cloud">
          <!-- 占位渲染 -->
          <span style="font-size:36px;" data-w="1"  style="--w:1">Syzygy</span>
          <span style="font-size:26px;" data-w=".8" style="--w:.8">听话</span>
          <span style="font-size:22px;" data-w=".7" style="--w:.7">现在</span>
          <span style="font-size:20px;" data-w=".6" style="--w:.6">抱紧</span>
        </div>
      </section>

      <!-- 开头句式 -->
      <section class="card stack" id="card-starters">
        <div class="section-title">Top5 常用开头句式</div>
        <ol id="starters" class="stack">
          <li>〈称呼〉，听话，…… <span class="small">支持度 —</span></li>
          <li>现在，…… <span class="small">支持度 —</span></li>
        </ol>
      </section>

      <!-- 口癖模板 -->
      <section class="card stack" id="card-catch">
        <div class="section-title">Top3 口癖模板</div>
        <ol id="catchphrases" class="stack">
          <li>〈命令式起手〉 + 〈称呼〉 + 〈动作〉 <span class="small">支持度 —</span></li>
        </ol>
      </section>

      <!-- 模型占比 -->
      <section class="card stack" id="card-models">
        <div class="section-title">模型使用占比（近三个月）</div>
        <div class="row small">
          <select id="win"><option value="rolling">滚动90天</option><option value="calendar">日历三月</option></select>
          <select id="metric"><option value="chars">字符占比</option><option value="msgs">消息数占比</option><option value="tokens">近似token占比</option></select>
          <select id="view"><option value="family">家族视图</option><option value="model">具体型号</option></select>
        </div>
        <div id="models-chart" style="height:220px;display:flex;align-items:center;justify-content:center;">
          <span class="muted">圆环图占位（后续接入渲染）</span>
        </div>
      </section>
    </main>

    <!-- 底部：轻导出 -->
    <footer class="footer">
      <div class="card row" style="justify-content:space-between;align-items:center">
        <span class="small">当前主题与标题会同步用于导出长图。</span>
        <button class="btn" id="btn-save">保存为图片</button>
      </div>
    </footer>
  </div>

  <script type="module">
    import { parseJSONStream } from './src/ingest/stream-parse.js';
    import { clearAll, listShards, readShardMessages } from './src/ingest/db.js';
    import { WorkerPool } from './src/workers/pool.js';
    import { mergePartials, exactRecount, scoreCandidates, buildTopViews, reconcileTopViews } from './src/stats/merge.js';
    import { threeMonthCutoff, filterMessagesByWindow } from './src/stats/models.js';
    import { finalizeYearAgg, computeYearlyMetrics } from './src/stats/timeline.js';
    // —— 主题下拉 —— //
    const themeSel = document.getElementById('theme');
    themeSel.addEventListener('change', ()=> {
      document.documentElement.setAttribute('data-theme', themeSel.value);
    });

    async function runStatsPipeline({ mask }) {
      if (cancelRequested) return;
      try {
        let shards = [];
        const cutoff = threeMonthCutoff();
        try {
          shards = await listShards({ cutoff });
        } catch (err) {
          console.error('读取分片列表失败', err);
          return;
        }
        if (cancelRequested) return;

        const allShards = Array.isArray(shards) ? shards.filter((s) => s && s.id != null) : [];
        if (!allShards.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 无可用分片' });
          await yieldToUi();
          refreshCloud();
          return;
        }

        const recentShards = allShards
          .filter((shard) => {
            if (typeof shard?.maxTs === 'number' && Number.isFinite(shard.maxTs)) {
              return shard.maxTs >= cutoff;
            }
            return true;
          })
          .sort((a, b) => {
            const aMax = typeof a?.maxTs === 'number' ? a.maxTs : typeof a?.minTs === 'number' ? a.minTs : -Infinity;
            const bMax = typeof b?.maxTs === 'number' ? b.maxTs : typeof b?.minTs === 'number' ? b.minTs : -Infinity;
            if (bMax !== aMax) return bMax - aMax;
            return (b.id || 0) - (a.id || 0);
          });

        if (!recentShards.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 无近90天分片' });
          await yieldToUi();
          refreshCloud();
          return;
        }

        updateProgressBars({ statsPct: 0, statsPhase: '阶段1 · MG/CMS（近90天）' });

        const workerUrl = new URL('./src/workers/shard-worker.js', import.meta.url).href;
        let poolSize = 4;
        if (typeof navigator !== 'undefined' && typeof navigator.hardwareConcurrency === 'number') {
          const suggested = Math.max(1, Math.floor(navigator.hardwareConcurrency - 1));
          poolSize = Math.min(4, Math.max(suggested, 1));
        }
        poolSize = Math.max(1, Math.min(poolSize, recentShards.length));
        if (poolSize < 3 && recentShards.length >= 3) {
          poolSize = 3;
        }

        const pool = new WorkerPool(poolSize, workerUrl);
        const partials = [];
        let completed = 0;

        try {
          for (const shard of recentShards) {
            if (cancelRequested) break;
            const messages = await readShardMessages(shard.id);
            if (cancelRequested) break;
            const filtered = filterMessagesByWindow(messages, cutoff);
            if (!filtered.length) {
              completed += 1;
              updateProgressBars({ statsPct: Math.min(50, (completed / recentShards.length) * 50) });
              await yieldToUi();
              continue;
            }
            const result = await pool.run({
              shardId: shard.id,
              messages: filtered,
              mask,
              cutoff,
            });
            if (cancelRequested) break;
            if (result?.error) {
              throw new Error(result.error.message || 'Worker 计算失败');
            }
            partials.push({ ...result, shardId: shard.id });
            completed += 1;
            updateProgressBars({ statsPct: Math.min(50, (completed / recentShards.length) * 50) });
            await yieldToUi();
          }
        } finally {
          await pool.terminate();
        }

        if (cancelRequested) return;

        const merged = mergePartials(partials);
        statsState.candidates = merged.candidates;
        statsState.candidatesByN = merged.candidatesByN || { 1: [], 2: [], 3: [] };
        statsState.totalTokens = merged.totalTokens;

        if (!statsState.candidates.length) {
          updateProgressBars({ statsPct: 100, statsPhase: '阶段1 · 窗口内无候选' });
        } else {
          updateProgressBars({ statsPct: 50, statsPhase: '阶段2 · 精确重算（近90天）' });
        }

        if (!statsState.candidates.length) {
          await yieldToUi();
          statsState.counts = new Map();
          statsState.sortedCandidates = [];
          statsState.top10 = [];
          statsState.candidatesByN = { 1: [], 2: [], 3: [] };
          statsState.views = { phrases: [], words: [] };
          refreshCloud();
          return;
        }

        const now = typeof performance !== 'undefined' && typeof performance.now === 'function'
          ? () => performance.now()
          : () => Date.now();
        const recountStart = now();
        const iterShardText = async (shardId) => {
          if (cancelRequested) {
            return { messages: [] };
          }
          const messages = await readShardMessages(shardId);
          if (cancelRequested) {
            return { messages: [] };
          }
          const filtered = filterMessagesByWindow(messages, cutoff);
          if (!filtered.length) {
            return { messages: [] };
          }
          return { messages: filtered };
        };
        iterShardText.shardIds = recentShards.map((s) => s.id);
        iterShardText.cutoff = cutoff;
        iterShardText.mask = mask;

        updateProgressBars({ statsPct: 50, statsPhase: '阶段2 · Recount phrases …' });

        const recountMap = await exactRecount(
          merged.candidates,
          iterShardText,
          async ({ doneShards, totalShards }) => {
            if (cancelRequested) return;
            const phasePct = totalShards ? 50 + (doneShards / totalShards) * 50 : 100;
            updateProgressBars({ statsPct: Math.min(100, phasePct), statsPhase: '阶段2 · Recount phrases …' });
            if (DEBUG_STATS) {
              const elapsedMs = Math.round(now() - recountStart);
              console.debug('[stats]', { phase: 'recount', doneShards, totalShards, elapsedMs });
            }
            await yieldToUi();
          },
          { shouldAbort: () => cancelRequested },
        );
        const recountEnd = now();
        if (cancelRequested) return;
        statsState.recountTimeMs = recountEnd - recountStart;
        statsState.counts = recountMap;
        const scored = scoreCandidates(recountMap, statsState.totalTokens);
        statsState.sortedCandidates = scored;
        updateProgressBars({ statsPct: 100, statsPhase: '完成 · 近90天处理完毕' });

        refreshCloud();

        if (DEBUG_STATS) {
          console.debug('[stats]', {
            totalTokens: statsState.totalTokens,
            distinctCandidates: statsState.counts.size,
            recountTimeMs: Math.round(statsState.recountTimeMs),
          });
        }
      } catch (err) {
        if (err && typeof err === 'object') {
          err.__stats = true;
        }
        statsState.counts = new Map();
        statsState.sortedCandidates = [];
        statsState.top10 = [];
        statsState.totalTokens = 0;
        statsState.recountTimeMs = 0;
        statsState.candidatesByN = { 1: [], 2: [], 3: [] };
        statsState.views = { phrases: [], words: [] };
        refreshCloud();
        throw err;
      }
    }

    // —— 标题替换（仅替换“GPT”段） —— //
    const titleInput = document.getElementById('title-input');
    const titleName  = document.getElementById('title-name');
    titleInput.addEventListener('input', () => {
      const v = (titleInput.value || 'My GPT').trim();
      titleName.textContent = v;
      document.title = `Echo：${v}`;
    });

    // —— 进度条占位：接入解析/统计后在此更新 —— //
    const p1=document.getElementById('p-parse'), p2=document.getElementById('p-shard'), p3=document.getElementById('p-stat');
    const statsPhaseLabel = document.getElementById('stats-phase-label');
    const setProgress=(el,val)=>{ el.style.width=Math.max(0,Math.min(100,val))+'%'; };
    const setStatsPhase = (text) => {
      if (!statsPhaseLabel) return;
      const next = text ? String(text) : '';
      statsPhaseLabel.textContent = next;
      statsPhaseLabel.style.display = next ? '' : 'none';
    };
    const yieldToUi = () => new Promise((resolve) => setTimeout(resolve, 0));
    const resetProgressBars = () => {
      setProgress(p1,0);
      setProgress(p2,0);
      setProgress(p3,0);
      setStatsPhase('');
    };

    const maskInput = document.getElementById('mask');

    const state = {
      mask: false,
    };

    const statsState = {
      counts: new Map(),
      sortedCandidates: [],
      candidates: [],
      candidatesByN: { 1: [], 2: [], 3: [] },
      totalTokens: 0,
      recountTimeMs: 0,
      top10: [],
      cloudMode: 'phrases',
      views: { phrases: [], words: [] },
    };

    const yearlyState = {
      data: {},
    };

    const DEBUG_STATS = false;

    // —— 文件选择与开始/中断 —— //
    const fileInput=document.getElementById('file');
    const fileNameSpan = document.getElementById('file-name');
    const parseBtn = document.getElementById('btn-parse');
    const cancelBtn = document.getElementById('btn-cancel');
    const parseBtnLabel = parseBtn.textContent;
    const cloudToggle = document.getElementById('cloud-toggle');

    let currentRunPromise = null;
    let currentController = null;
    let cancelRequested = false;

    const updateProgressBars = ({ parsePct, shardPct, statsPct, statsPhase }) => {
      if (typeof parsePct === 'number') setProgress(p1, parsePct);
      if (typeof shardPct === 'number') setProgress(p2, shardPct);
      if (typeof statsPct === 'number') setProgress(p3, statsPct);
      if (statsPhase !== undefined) setStatsPhase(statsPhase);
    };

    const resetUiState = () => {
      resetProgressBars();
      parseBtn.disabled = false;
      parseBtn.textContent = parseBtnLabel;
      cancelBtn.disabled = false;
    };

    function updateCloudToggleButtons(mode) {
      if (!cloudToggle) return;
      const nextMode = mode === 'words' ? 'words' : 'phrases';
      const buttons = cloudToggle.querySelectorAll('button[data-mode]');
      buttons.forEach((btn) => {
        const isActive = btn.dataset.mode === nextMode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    if (cloudToggle) {
      cloudToggle.addEventListener('click', (event) => {
        const target = event.target.closest('button[data-mode]');
        if (!target) return;
        const mode = target.dataset.mode === 'words' ? 'words' : 'phrases';
        if (statsState.cloudMode === mode) {
          updateCloudToggleButtons(mode);
          return;
        }
        statsState.cloudMode = mode;
        updateCloudToggleButtons(mode);
        refreshCloud();
      });
    }

    updateCloudToggleButtons(statsState.cloudMode);

    resetProgressBars();

    fileInput.addEventListener('change', () => {
      const fileName = fileInput.files?.[0]?.name || '';
      fileNameSpan.textContent = fileName ? `已选择：${fileName}` : '';
    });
    parseBtn.addEventListener('click', async ()=>{
      if(currentRunPromise){ return; }
      if(!fileInput.files?.[0]){ alert('请选择 JSON 文件'); return; }

      cancelRequested = false;
      resetProgressBars();
      state.mask = !!maskInput?.checked;
      statsState.counts.clear();
      statsState.sortedCandidates = [];
      statsState.candidates = [];
      statsState.candidatesByN = { 1: [], 2: [], 3: [] };
      statsState.totalTokens = 0;
      statsState.recountTimeMs = 0;
      statsState.top10 = [];
      statsState.views = { phrases: [], words: [] };
      refreshCloud();
      yearlyState.data = {};
      renderYearlyOverview({});
      parseBtn.disabled = true;
      parseBtn.textContent = '解析中…';
      cancelBtn.disabled = false;

      const file = fileInput.files[0];
      const assistName = (document.getElementById('assist-filter')?.value || '').trim();
      currentController = new AbortController();

      const run = (async () => {
        try {
          const parseResult = await parseJSONStream(
            file,
            () => {
              /* 消息级聚合将在后续任务接入 */
            },
            (progress) => {
              if (cancelRequested) return;
              updateProgressBars(progress || {});
            },
            { assistName, signal: currentController.signal },
          );
          if (!cancelRequested) {
            const yearly = finalizeYearAgg();
            yearlyState.data = yearly;
            renderYearlyOverview(yearly);
          }
          if (!cancelRequested && parseResult?.aborted !== true) {
            await runStatsPipeline({ mask: state.mask });
          }
        } catch (err) {
          if (err?.name !== 'AbortError') {
            const label = err?.__stats ? '统计计算失败' : '解析过程中出错';
            console.error(label, err);
          }
        } finally {
          currentController = null;
          currentRunPromise = null;
          parseBtn.disabled = false;
          parseBtn.textContent = parseBtnLabel;
          if (cancelRequested) {
            resetProgressBars();
          }
        }
      })();

      currentRunPromise = run;
      try {
        await run;
      } catch (err) {
        if (err?.name !== 'AbortError') {
          console.error('解析结束时出错', err);
        }
      }
    });
    cancelBtn.addEventListener('click', async ()=>{
      cancelRequested = true;
      if(currentController && !currentController.signal.aborted){
        currentController.abort();
      }

      try {
        await currentRunPromise;
      } catch (err) {
        if (err?.name !== 'AbortError') {
          console.error('取消过程中出错', err);
        }
      } finally {
        currentRunPromise = null;
        currentController = null;
      }

      try {
        await clearAll();
      } catch (err) {
        console.error('清空分片失败', err);
      }

      statsState.counts.clear();
      statsState.sortedCandidates = [];
      statsState.candidates = [];
      statsState.candidatesByN = { 1: [], 2: [], 3: [] };
      statsState.totalTokens = 0;
      statsState.recountTimeMs = 0;
      statsState.top10 = [];
      statsState.views = { phrases: [], words: [] };
      refreshCloud();
      yearlyState.data = {};
      renderYearlyOverview({});

      resetUiState();
      cancelRequested = false;
    });

    // —— 年度概览渲染 —— //
    function updateYearlyTableResponsive(){
      const table = document.getElementById('yearly-table');
      if (!table || typeof window === 'undefined') return;
      const responsive = typeof window.matchMedia === 'function'
        ? window.matchMedia('(max-width: 480px)').matches
        : window.innerWidth <= 480;
      table.classList.toggle('responsive', !!responsive);
    }

    if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
      window.addEventListener('resize', updateYearlyTableResponsive);
    }

    function renderYearlyOverview(summary){
      const tbody = document.querySelector('#yearly-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const entries = Object.entries(summary || {})
        .map(([year, value]) => [Number(year), value])
        .filter(([year]) => !Number.isNaN(year))
        .sort((a, b) => b[0] - a[0]);

      const numberFormatter = (typeof Intl !== 'undefined' && Intl.NumberFormat)
        ? new Intl.NumberFormat()
        : null;
      const averageFormatter = (typeof Intl !== 'undefined' && Intl.NumberFormat)
        ? new Intl.NumberFormat(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })
        : null;
      const zeroAverage = averageFormatter ? averageFormatter.format(0) : '0.0';
      const formatNumber = (value) => {
        if (!Number.isFinite(value)) return '0';
        if (value === 0) return '0';
        return numberFormatter ? numberFormatter.format(value) : String(value);
      };
      const formatAverage = (value) => {
        if (!Number.isFinite(value)) return zeroAverage;
        return averageFormatter ? averageFormatter.format(value) : value.toFixed(1);
      };

      const columnLabels = {
        year: '年份',
        messages: '消息总条数',
        chars: '总字数',
        images: '总图片数',
        avgPerDay: '日均字数',
        topMonth: '最活跃月',
        avgAssistant: 'GPT平均字数',
        streaks: '连续活跃',
      };

      const resolveActiveDays = (days) => {
        if (!days) return 0;
        if (days instanceof Set) return days.size;
        if (Array.isArray(days)) return days.length;
        const num = Number(days);
        return Number.isFinite(num) && num > 0 ? num : 0;
      };

      const toOrdinal = (value) => {
        if (typeof value === 'string') {
          const parts = value.split('-');
          if (parts.length === 3) {
            const [y, m, d] = parts.map((part) => Number(part));
            if ([y, m, d].every((n) => Number.isInteger(n))) {
              return Date.UTC(y, m - 1, d);
            }
          }
        }
        const num = Number(value);
        if (Number.isFinite(num)) {
          const date = new Date(num);
          if (!Number.isNaN(date.getTime())) {
            return Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
          }
        }
        return null;
      };

      const computeStreakStats = (days) => {
        const source = days instanceof Set ? Array.from(days) : Array.isArray(days) ? days : [];
        if (!source.length) return { streakCount: 0, longestStreak: 0 };
        const ordinals = source
          .map((value) => toOrdinal(value))
          .filter((value) => Number.isFinite(value))
          .sort((a, b) => a - b);
        if (!ordinals.length) return { streakCount: 0, longestStreak: 0 };
        const DAY_MS = 24 * 60 * 60 * 1000;
        let streakCount = 0;
        let longest = 0;
        let current = 0;
        let previous = null;
        ordinals.forEach((ordinal) => {
          if (previous === null || ordinal - previous > DAY_MS) {
            streakCount += 1;
            current = 1;
          } else if (ordinal - previous === DAY_MS) {
            current += 1;
          } else {
            current = Math.max(1, current);
          }
          if (current > longest) {
            longest = current;
          }
          previous = ordinal;
        });
        if (longest === 0) longest = 1;
        return { streakCount, longestStreak: longest };
      };

      if (!entries.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 8;
        cell.className = 'muted';
        cell.textContent = '暂无统计';
        row.appendChild(cell);
        tbody.appendChild(row);
        updateYearlyTableResponsive();
        return;
      }

      const derived = computeYearlyMetrics(summary);
      const monthLabels = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];

      entries.forEach(([year, value]) => {
        const entry = value || {};
        const metrics = (derived && derived[year]) || {};
        const totalMessages = Number.isFinite(metrics.totalMessages)
          ? metrics.totalMessages
          : Number(entry.totalMessages) || 0;
        const assistantMsgs = Number.isFinite(metrics.assistantMsgs)
          ? metrics.assistantMsgs
          : Number(entry.assistantMsgs) || 0;
        const totalChars = Number.isFinite(metrics.totalChars)
          ? metrics.totalChars
          : Number(entry.totalChars) || 0;
        const assistantChars = Number.isFinite(metrics.assistantChars)
          ? metrics.assistantChars
          : Number(entry.assistantChars) || 0;
        const images = Number.isFinite(metrics.images)
          ? metrics.images
          : Number(entry.images) || 0;
        const avgCharsPerActiveDay = Number.isFinite(metrics.avgCharsPerActiveDay)
          ? metrics.avgCharsPerActiveDay
          : 0;
        const mostActiveMonth = Number.isFinite(metrics.mostActiveMonth)
          ? metrics.mostActiveMonth
          : 0;
        const avgAssistantMsgLen = Number.isFinite(metrics.avgAssistantMsgLen)
          ? metrics.avgAssistantMsgLen
          : 0;
        const row = document.createElement('tr');

        const activeDaysSource = metrics.activeDays || entry.activeDays;
        const activeDayCount = resolveActiveDays(activeDaysSource);

        const yearCell = document.createElement('td');
        yearCell.setAttribute('data-label', columnLabels.year);
        const yearMain = document.createElement('div');
        yearMain.textContent = String(year);
        yearCell.appendChild(yearMain);
        if (activeDayCount > 0) {
          const sub = document.createElement('div');
          sub.className = 'small muted';
          sub.textContent = `活跃天数 ${formatNumber(activeDayCount)}`;
          yearCell.appendChild(sub);
        }
        row.appendChild(yearCell);

        const msgsCell = document.createElement('td');
        msgsCell.className = 'num';
        msgsCell.setAttribute('data-label', columnLabels.messages);
        msgsCell.textContent = formatNumber(totalMessages);
        if (Number.isFinite(assistantMsgs) && assistantMsgs > 0) {
          const sub = document.createElement('div');
          sub.className = 'small muted';
          sub.textContent = `GPT ${formatNumber(assistantMsgs)}`;
          msgsCell.appendChild(sub);
        }
        row.appendChild(msgsCell);

        const charsCell = document.createElement('td');
        charsCell.className = 'num';
        charsCell.setAttribute('data-label', columnLabels.chars);
        charsCell.textContent = formatNumber(totalChars);
        if (Number.isFinite(assistantChars) && assistantChars > 0) {
          const sub = document.createElement('div');
          sub.className = 'small muted';
          sub.textContent = `GPT ${formatNumber(assistantChars)}`;
          charsCell.appendChild(sub);
        }
        row.appendChild(charsCell);

        const imagesCell = document.createElement('td');
        imagesCell.className = 'num';
        imagesCell.setAttribute('data-label', columnLabels.images);
        imagesCell.textContent = formatNumber(images);
        row.appendChild(imagesCell);

        const avgCell = document.createElement('td');
        avgCell.className = 'num';
        avgCell.setAttribute('data-label', columnLabels.avgPerDay);
        avgCell.textContent = formatAverage(avgCharsPerActiveDay);
        row.appendChild(avgCell);

        const charsByMonth = Array.isArray(metrics.charsByMonth) ? metrics.charsByMonth : Array.isArray(entry.charsByMonth) ? entry.charsByMonth : [];
        const topMonthCell = document.createElement('td');
        topMonthCell.className = 'num';
        topMonthCell.setAttribute('data-label', columnLabels.topMonth);
        if (Number.isInteger(mostActiveMonth) && mostActiveMonth > 0) {
          const idx = Math.min(mostActiveMonth - 1, monthLabels.length - 1);
          const monthLabel = monthLabels[idx] || `${mostActiveMonth}`;
          const charsForMonth = Number(charsByMonth[idx]);
          const main = document.createElement('div');
          main.textContent = monthLabel;
          topMonthCell.appendChild(main);
          if (Number.isFinite(charsForMonth) && charsForMonth > 0) {
            const sub = document.createElement('div');
            sub.className = 'small muted';
            sub.textContent = formatNumber(charsForMonth);
            topMonthCell.appendChild(sub);
          }
        } else {
          topMonthCell.textContent = '—';
        }
        row.appendChild(topMonthCell);

        const assistantAvgCell = document.createElement('td');
        assistantAvgCell.className = 'num';
        assistantAvgCell.setAttribute('data-label', columnLabels.avgAssistant);
        assistantAvgCell.textContent = formatAverage(avgAssistantMsgLen);
        row.appendChild(assistantAvgCell);

        const streakCell = document.createElement('td');
        streakCell.className = 'streak num';
        streakCell.setAttribute('data-label', columnLabels.streaks);
        const streakStats = computeStreakStats(activeDaysSource);
        const streakMain = document.createElement('div');
        const streakCountText = formatNumber(streakStats.streakCount || 0);
        const longestText = formatNumber(streakStats.longestStreak || 0);
        streakMain.textContent = `${streakCountText}/${longestText}`;
        streakCell.appendChild(streakMain);
        if (activeDayCount > 0) {
          const sub = document.createElement('div');
          sub.className = 'small muted';
          sub.textContent = `活跃天数 ${formatNumber(activeDayCount)}`;
          streakCell.appendChild(sub);
        }
        row.appendChild(streakCell);

        tbody.appendChild(row);
      });
      updateYearlyTableResponsive();
    }

    renderYearlyOverview(yearlyState.data);
    updateYearlyTableResponsive();

    // —— 词云渲染占位（接入统计后调用） —— //
    function renderCloud(words){
      const host=document.getElementById('cloud'); host.innerHTML='';
      if(!Array.isArray(words) || !words.length){
        const placeholder=document.createElement('span');
        placeholder.className='muted';
        placeholder.textContent='暂无统计';
        host.appendChild(placeholder);
        return;
      }
      const maxScore = words.reduce((acc, item) => {
        const value = Number(item?.score);
        if (!Number.isFinite(value)) return acc;
        return Math.max(acc, Math.max(0, value));
      }, 0);
      const base = maxScore > 0 ? maxScore : 1;
      words.forEach((w)=>{
        const score = Number(w?.score);
        const weight = Number.isFinite(score) && score > 0 ? score / base : 0;
        const el=document.createElement('span');
        el.textContent=w.text;
        el.style.fontSize=(14+Math.round(26*weight))+'px';
        el.style.setProperty('--w', weight);
        el.setAttribute('data-w', String(weight));
        host.appendChild(el);
      });
    }
    // renderCloud([{text:'Syzygy',score:1},{text:'听话',score:.85},{text:'现在',score:.7},{text:'抱紧',score:.6}]);

    function updateTopViews(limit = 10) {
      const sorted = Array.isArray(statsState.sortedCandidates) ? statsState.sortedCandidates : [];
      const nextViews = buildTopViews(sorted, limit);
      statsState.views = reconcileTopViews(statsState.views, nextViews, { maxSwaps: 1 });
      return statsState.views;
    }

    function refreshCloud(){
      const limit = 10;
      const views = updateTopViews(limit) || {};
      const phraseViewRaw = Array.isArray(views.phrases) ? views.phrases : [];
      const wordViewRaw = Array.isArray(views.words) ? views.words : [];
      const phraseView = phraseViewRaw.slice(0, limit);
      const wordView = wordViewRaw.slice(0, limit);

      if (!phraseView.length && !wordView.length) {
        statsState.top10 = [];
        renderCloud([]);
        return;
      }

      const hasWordView = wordView.length > 0;
      const defaultView = phraseView.length ? phraseView : wordView;
      const active = (statsState.cloudMode === 'words' && hasWordView)
        ? wordView
        : defaultView;

      if (!active.length) {
        statsState.top10 = [];
        renderCloud([]);
        return;
      }

      const topScore = active[0]?.score || 0;
      const items = active.map((entry) => {
        const score = Number(entry?.score) || 0;
        const weight = topScore ? Math.max(0, score) / topScore : 0;
        return {
          text: entry.token,
          score,
          weight,
          count: Number(entry?.freq) || 0,
          pct: statsState.totalTokens ? (Number(entry?.freq) || 0) / statsState.totalTokens : 0,
          n: entry.n,
        };
      });

      statsState.top10 = items;
      renderCloud(items);
    }

    // —— 保存为图片（防截断版） —— //
document.getElementById('btn-save').addEventListener('click', async ()=>{
  if(!window.html2canvas){ alert('无法使用内置导出，请手动截图'); return; }

  const root=document.documentElement, body=document.body;

// 创建临时导出容器
const exportContainer = document.createElement('div');
exportContainer.style.cssText = 'padding:24px; background:'+getComputedStyle(document.body).backgroundColor;

// 克隆标题
const titleClone = document.createElement('div');
titleClone.innerHTML = `
  <h1 style="font-size:28px;font-weight:700;margin:0 0 8px;color:var(--text)">
    Echo：<span>${document.getElementById('title-name').textContent}</span>
  </h1>
  <p style="opacity:.65;font-size:14px;margin:0 0 24px;color:var(--text)">
    Analyze last 3 months of assistant messages (word cloud/starters/catchphrases & model share). Yearly overview aggregates both assistant and user.
  </p>
`;

// 克隆结果区
const resultsClone = document.getElementById('results').cloneNode(true);

exportContainer.appendChild(titleClone);
exportContainer.appendChild(resultsClone);
document.body.appendChild(exportContainer);

const target = exportContainer;
  const BG = getComputedStyle(body).backgroundColor;
  const SCALE = 2;        // 导出清晰度倍率
  const MARGIN = 40;      // 四周留白（px，按需改 24/40 等）

  root.classList.add('printing');
  try{ if(document.fonts && document.fonts.ready){ await document.fonts.ready; } await new Promise(r=>setTimeout(r,50)); }catch(_){}

  const w=Math.ceil(Math.max(target.scrollWidth, target.clientWidth));
  const h=Math.ceil(Math.max(target.scrollHeight, target.clientHeight));

  const canvas = await html2canvas(target,{
    scale:SCALE, useCORS:true, backgroundColor:BG,
    x:0, y:0, width:w, height:h,
    windowWidth:Math.max(w, window.innerWidth),
    windowHeight:h, scrollX:0, scrollY:-window.scrollY,
    onclone:(doc)=>doc.documentElement.classList.add('printing')
  });

  // —— 关键：在原图外再包一层留白画布 —— //
  const pad = Math.round(MARGIN * SCALE);
  const framed = document.createElement('canvas');
  framed.width  = canvas.width  + pad*2;
  framed.height = canvas.height + pad*2;

  const ctx = framed.getContext('2d');
  ctx.fillStyle = BG;             // 与页面一致的背景色
  ctx.fillRect(0,0,framed.width,framed.height);
  ctx.drawImage(canvas, pad, pad); // 原图居中放入

try {
  const safeName = document.getElementById('title-name').textContent.replace(/[\/\\:*?"<>|]/g, '-');
  const a = document.createElement('a');
  a.href = framed.toDataURL('image/png');
  a.download = `Echo-${safeName}.png`;
  a.click();
} catch(e) {
  alert('图片太大，导出失败。建议手动截图。');
}

root.classList.remove('printing');
  document.body.removeChild(exportContainer);
});

    // —— 脱敏状态（统计时读取） —— //
    maskInput.addEventListener('change', (e)=> {
      state.mask = !!e.target.checked;
    });
    state.mask = !!maskInput?.checked;
    refreshCloud();

    // —— 范围切换占位 —— //
    document.querySelectorAll('input[name="scope"]').forEach(r=>{
      r.addEventListener('change', ()=>{ /* TODO: 切换使用 globalMinTs / assistantMinTs 等聚合引用 */ });
    });
  </script>
</body>
</html>
