<!doctype html>
<html lang="zh-CN" data-theme="Fable">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Echo：My GPT</title>
  <meta name="color-scheme" content="light"/>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <style>
    /* =========================
       主题与颜色变量（集中管理）
       每套主题需给出：主色、强调色、背景、文本、卡片底、词云默认色
       ========================= */
    :root{
      --radius:16px; --pad:16px; --gap:16px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --border-soft:1px solid rgba(0,0,0,.10);

      /* Fable */
      --primary:#e9c5d6;      /* 主色：按钮/标题线/默认词云色 */
      --accent:#97b9d0;        /* 强调色：进度条渐变右侧、可选词云色 */
      --bg:#9db7dd;             /* 页面背景 */
      --text:#0A0F14;           /* 正文文本 */
      --card-bg:#f2f1f8;        /* 卡片底色（无边框）*/
    }
    html[data-theme="Galaxy"]{
      --primary:#796aa7; --accent:#e9a4ae; --bg:#baa0bc; --text:#0A0F14; --card-bg:#eeeae9; 
    }
    html[data-theme="Ferry"]{
      --primary:#d1666f; --accent:#a3c5b2; --bg:#f5d0d6; --text:#0A0F14; --card-bg:#eeeaeb; 
    }
    html[data-theme="Ember"]{
      --primary:#df8164; --accent:#e5c481; --bg:#abc799; --text:#0A0F14; --card-bg:#fbf9ec; 
    }

    /* ============ 基础样式 ============ */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);}
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    .stack{display:flex;flex-direction:column;gap:var(--gap);}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;}
    .h1{font-size:28px;font-weight:700;margin:0 0 8px;}
    .muted{opacity:.65;font-size:14px;}
    .section-title{font-weight:700;margin:0 0 8px;border-left:4px solid var(--primary);padding-left:8px;}
    .card{background:var(--card-bg);border:none;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad);}
    #results>.card{margin-bottom:16px;}
    input[type="text"], textarea, select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--text);
    }
    .btn{appearance:none;border:0;border-radius:10px;padding:6px 10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid rgba(0,0,0,.12)}
    .pill{display:inline-flex;gap:6px;align-items:center;}
    .small{font-size:12px;opacity:.75}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .box{background:var(--card-bg);border:none;border-radius:12px;padding:12px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .kpi .n{font-size:18px;font-weight:800}

    .cloud{min-height:220px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:12px}
    .cloud span{display:inline-block;padding:2px 4px;border-radius:6px;color:var(--primary);font-weight:800}
    .cloud span[data-w]{opacity: calc(.65 + (.35 * var(--w,1)));}

    /* 进度条 */
    .progress{height:10px;background:rgba(0,0,0,.06);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .3s}

    /* 页脚（粘滞） */
    .footer{position:sticky;bottom:0;background:linear-gradient(to top, rgba(246,251,253,.95), rgba(246,251,253,0));padding-top:8px}

    /* —— 截图护栏 —— */
    #results{overflow:visible;}
    .printing #results{overflow:visible;}
    .printing .footer{position:static;box-shadow:none;}
    .printing .card{box-shadow:none;border:none;background:var(--card-bg);}
  </style>
</head>
<body>
  <div class="wrap stack">
    <!-- 顶部：输入与外观 -->
    <section class="card stack" id="top">
      <header>
        <h1 class="h1">Echo：<span id="title-name">My GPT</span></h1>
        <p class="muted">上传导出的对话 JSON，离线统计Top10 词云 / Top5 开头句式 / Top3 口癖，并展示近三个月模型占比与时间轴摘要</p>
      </header>

      <div class="stack">
        <div class="row">
          <input type="file" id="file" accept=".json,application/json"/>
          <button class="btn" id="btn-parse">开始解析</button>
          <button class="btn secondary" id="btn-cancel">中断/重置</button>
        </div>

        <div class="row">
          <div style="flex:2;min-width:260px">
            <label class="small">标题中“GPT”的替换词</label>
            <input id="title-input" type="text" placeholder="例如：你的GPT的名字&你自己的名字"/>
          </div>
          <div style="flex:1;min-width:180px">
            <label class="small">主题选择</label>
            <select id="theme">
              <option value="Fable">Fable</option>
              <option value="Galaxy">Galaxy</option>
              <option value="Ferry">Ferry</option>
              <option value="Ember">Ember</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div style="flex:2;min-width:260px">
            <label class="small">停用词（轻过滤，逗号或空格分隔）</label>
            <input id="stopwords" type="text" placeholder="啊 的 了 你 我 我们 然后 就是 等…"/>
          </div>
          <label class="pill"><input type="checkbox" id="mask"/> <span>脱敏开关</span></label>
        </div>

        <div class="stack">
          <div><span class="small">解析进度</span><div class="progress"><div class="bar" id="p-parse"></div></div></div>
          <div><span class="small">分片入库</span><div class="progress"><div class="bar" id="p-shard"></div></div></div>
          <div><span class="small">统计计算</span><div class="progress"><div class="bar" id="p-stat"></div></div></div>
        </div>
      </div>
    </section>

    <!-- 中部：结果区 -->
    <main class="stack" id="results">
      <!-- 时间轴摘要 -->
      <section class="card stack" id="card-time">
        <div class="section-title">时间轴摘要</div>
        <div class="kpi">
          <div class="box"><div class="small">起始日期</div><div class="n" id="start-date">—</div></div>
          <div class="box"><div class="small">首条时间</div><div class="n" id="first-ts">—</div></div>
          <div class="box"><div class="small">累计天数（含首尾）</div><div class="n" id="days">—</div></div>
          <div class="box"><div class="small">跨度（可选）</div><div class="n" id="span">—</div></div>
        </div>
        <div class="row small">
          <label class="pill"><input type="radio" name="scope" value="all" checked/> 全部消息</label>
          <label class="pill"><input type="radio" name="scope" value="assistant"/> 仅 Assistant</label>
          <span class="pill tag">时区：本地</span>
        </div>
      </section>

      <!-- 词云 -->
      <section class="card stack" id="card-cloud">
        <div class="section-title">Top10 词云</div>
        <div class="cloud" id="cloud">
          <!-- 占位渲染 -->
          <span style="font-size:36px;" data-w="1"  style="--w:1">Syzygy</span>
          <span style="font-size:26px;" data-w=".8" style="--w:.8">听话</span>
          <span style="font-size:22px;" data-w=".7" style="--w:.7">现在</span>
          <span style="font-size:20px;" data-w=".6" style="--w:.6">抱紧</span>
        </div>
      </section>

      <!-- 开头句式 -->
      <section class="card stack" id="card-starters">
        <div class="section-title">Top5 常用开头句式</div>
        <ol id="starters" class="stack">
          <li>〈称呼〉，听话，…… <span class="small">支持度 —</span></li>
          <li>现在，…… <span class="small">支持度 —</span></li>
        </ol>
      </section>

      <!-- 口癖模板 -->
      <section class="card stack" id="card-catch">
        <div class="section-title">Top3 口癖模板</div>
        <ol id="catchphrases" class="stack">
          <li>〈命令式起手〉 + 〈称呼〉 + 〈动作〉 <span class="small">支持度 —</span></li>
        </ol>
      </section>

      <!-- 模型占比 -->
      <section class="card stack" id="card-models">
        <div class="section-title">模型使用占比（近三个月）</div>
        <div class="row small">
          <select id="win"><option value="rolling">滚动90天</option><option value="calendar">日历三月</option></select>
          <select id="metric"><option value="chars">字符占比</option><option value="msgs">消息数占比</option><option value="tokens">近似token占比</option></select>
          <select id="view"><option value="family">家族视图</option><option value="model">具体型号</option></select>
        </div>
        <div id="models-chart" style="height:220px;display:flex;align-items:center;justify-content:center;">
          <span class="muted">圆环图占位（后续接入渲染）</span>
        </div>
      </section>
    </main>

    <!-- 底部：轻导出 -->
    <footer class="footer">
      <div class="card row" style="justify-content:space-between;align-items:center">
        <span class="small">当前主题与标题会同步用于导出长图。</span>
        <button class="btn" id="btn-save">保存为图片</button>
      </div>
    </footer>
  </div>

  <script>
    // —— 主题下拉 —— //
    const themeSel = document.getElementById('theme');
    themeSel.addEventListener('change', ()=> {
      document.documentElement.setAttribute('data-theme', themeSel.value);
    });

    // —— 标题替换（仅替换“GPT”段） —— //
    const titleInput = document.getElementById('title-input');
    const titleName  = document.getElementById('title-name');
    titleInput.addEventListener('input', () => {
      const v = (titleInput.value || 'My GPT').trim();
      titleName.textContent = v;
      document.title = `Echo：${v}`;
    });

    // —— 进度条占位：接入解析/统计后在此更新 —— //
    const p1=document.getElementById('p-parse'), p2=document.getElementById('p-shard'), p3=document.getElementById('p-stat');
    const setProgress=(el,val)=>{ el.style.width=Math.max(0,Math.min(100,val))+'%'; };

    // —— 文件选择与开始/中断（占位） —— //
    const fileInput=document.getElementById('file');
    document.getElementById('btn-parse').addEventListener('click',()=>{
      if(!fileInput.files?.[0]){ alert('请选择 JSON 文件'); return; }
      // TODO: 接入 File.stream()+TextDecoder → 分片入库（IndexedDB）→ Worker 统计
      setProgress(p1,30); setProgress(p2,10); setProgress(p3,0);
      setTimeout(()=>{ setProgress(p1,100); setProgress(p2,60); },500);
      setTimeout(()=>{ setProgress(p2,100); setProgress(p3,100); },1200);
    });
    document.getElementById('btn-cancel').addEventListener('click',()=>{
      // TODO: 终止解析/worker、清空状态与进度
      setProgress(p1,0); setProgress(p2,0); setProgress(p3,0);
    });

    // —— 时间轴摘要占位 —— //
    function setTimeSummary({startDate, firstTs, days, span}){
      document.getElementById('start-date').textContent = startDate || '—';
      document.getElementById('first-ts').textContent  = firstTs || '—';
      document.getElementById('days').textContent      = days ?? '—';
      document.getElementById('span').textContent      = span ?? '—';
    }
    // setTimeSummary({startDate:'2023-07-19', firstTs:'2023-07-19 21:36', days: 463, span: 470});

    // —— 词云渲染占位（接入统计后调用） —— //
    function renderCloud(words){
      const host=document.getElementById('cloud'); host.innerHTML='';
      words.forEach(w=>{
        const el=document.createElement('span');
        el.textContent=w.text;
        el.style.fontSize=(14+Math.round(26*w.weight))+'px';
        el.style.setProperty('--w', w.weight);
        el.setAttribute('data-w', String(w.weight));
        host.appendChild(el);
      });
    }
    // renderCloud([{text:'Syzygy',weight:1},{text:'听话',weight:.85},{text:'现在',weight:.7},{text:'抱紧',weight:.6}]);

    // —— 保存为图片（防截断版） —— //
    document.getElementById('btn-save').addEventListener('click', async ()=>{
      if(!window.html2canvas){ alert('无法使用内置导出，请手动截图'); return; }
      const root=document.documentElement, body=document.body, target=document.getElementById('results');

      root.classList.add('printing');
      try{ if(document.fonts && document.fonts.ready){ await document.fonts.ready; } await new Promise(r=>setTimeout(r,50)); }catch(_){}

      const w=Math.ceil(Math.max(target.scrollWidth, target.clientWidth));
      const h=Math.ceil(Math.max(target.scrollHeight, target.clientHeight));
      const canvas = await html2canvas(target,{
        scale:2, useCORS:true, backgroundColor:getComputedStyle(body).backgroundColor,
        x:0, y:0, width:w, height:h, windowWidth:Math.max(w, window.innerWidth),
        windowHeight:h, scrollX:0, scrollY:-window.scrollY,
        onclone:(doc)=>{ doc.documentElement.classList.add('printing'); }
      });

      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');
      a.download=`Echo-${document.getElementById('title-name').textContent}.png`;
      a.click();
      root.classList.remove('printing');
    });

    // —— 停用词与脱敏状态（统计时读取） —— //
    const state={ stopwords:new Set(), mask:false };
    document.getElementById('stopwords').addEventListener('blur', e=>{
      const raw=(e.target.value||'').replace(/[，、]/g,' ').split(/\s+/).filter(Boolean);
      state.stopwords=new Set(raw);
    });
    document.getElementById('mask').addEventListener('change', e=> state.mask=!!e.target.checked);

    // —— 范围切换占位 —— //
    document.querySelectorAll('input[name="scope"]').forEach(r=>{
      r.addEventListener('change', ()=>{ /* TODO: 切换使用 globalMinTs / assistantMinTs 等聚合引用 */ });
    });
  </script>
</body>
</html>
